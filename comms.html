<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Silent Beacon — Secure Comms</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --neo:#0f0; --bg:#000; }
    html,body{height:100%;margin:0}
    body{
      background:#000; color:var(--neo);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      overflow:hidden;
    }
    /* Matrix */
    #matrix{ position:fixed; inset:0; z-index:-1; }

    .wrap{ display:flex; flex-direction:column; align-items:center; }
    h1{
      margin:10vh 0 2vh; font-weight:700; letter-spacing:.03em;
      text-shadow:0 0 12px #0f0, 0 0 28px #0f0;
      text-align:center;
    }
    .lead{ opacity:.85; margin-bottom:6vh; text-align:center }

    .btn{
      display:inline-block; padding:22px 44px; font-size:1.25rem;
      border:2px solid var(--neo); color:var(--neo); background:transparent;
      box-shadow:0 0 14px #0f0, inset 0 0 6px #0f0; cursor:pointer;
      letter-spacing:.2em; text-transform:uppercase; transition:.2s transform, .2s box-shadow, .2s background;
    }
    .btn:hover{ transform:scale(1.04); background:rgba(0,255,0,.12); box-shadow:0 0 24px #0f0, inset 0 0 10px #0f0; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Slide-up panel */
    .panel{
      position:fixed; left:50%; bottom:-70vh; transform:translateX(-50%);
      width:min(720px, 92vw); background:rgba(0,0,0,.85);
      border:1px solid rgba(0,255,0,.35); border-radius:14px;
      box-shadow:0 0 30px rgba(0,255,0,.25), inset 0 0 18px rgba(0,255,0,.12);
      padding:18px 18px 16px; transition:bottom .36s ease;
    }
    .panel.show{ bottom:6vh; }
    .panel.dissolve{ animation:dissolve .8s ease forwards; }
    @keyframes dissolve{ to{ opacity:0; transform:translateX(-50%) scale(.98); } }

    form{ display:grid; gap:14px; }
    label{ font-size:.9rem; opacity:.9 }
    input, textarea{
      width:100%; background:rgba(0,0,0,.55); color:#0f0; border:1px solid rgba(0,255,0,.35);
      border-radius:8px; padding:12px 12px; font:inherit; outline:none;
      box-shadow: inset 0 0 10px rgba(0,255,0,.06);
    }
    textarea{ min-height:160px; resize:vertical; }
    .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    .hint{ font-size:.85rem; opacity:.78 }
    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:2px; }
    .status{ min-height:1.4em; opacity:.9 }

    .toast{
      position:fixed; left:50%; top:14px; transform:translateX(-50%) translateY(-18px);
      background:rgba(0,0,0,.9); border:1px solid rgba(0,255,0,.5);
      padding:10px 16px; border-radius:10px; box-shadow:0 0 20px rgba(0,255,0,.35);
      opacity:0; transition:.25s ease; pointer-events:none; z-index:2;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <div class="wrap">
    <h1>Silent Beacon – Secure Communications Portal</h1>
    <p class="lead">One secure channel. Messages are end-to-end encrypted in your browser with our Proton public key.</p>
    <!-- Bigger, lower button per your request -->
    <button id="openSecure" class="btn" style="margin-top:6vh;">Secure</button>
  </div>

  <!-- Slide-up secure form -->
  <div id="panel" class="panel" aria-hidden="true">
    <form id="sb-form" autocomplete="off">
      <div class="row">
        <div>
          <label for="sb-callsign">Callsign (optional)</label>
          <input id="sb-callsign" name="callsign" placeholder="e.g., Darkstar" />
        </div>
        <div>
          <label for="sb-email">Reply email (optional)</label>
          <input id="sb-email" name="reply" inputmode="email" placeholder="Proton preferred for E2E" />
        </div>
      </div>

      <div>
        <label for="sb-message">Message</label>
        <textarea id="sb-message" name="message" required placeholder="Type your message…"></textarea>
      </div>

      <input type="hidden" id="sb-ts" name="ts" value="">

      <div class="hint">Tip: for full end-to-end, use a Proton address for replies. Your message is encrypted locally before transmission.</div>

      <div class="status" id="sb-status"></div>
      <div class="actions">
        <button type="button" id="cancelBtn" class="btn" style="opacity:.8;">Cancel</button>
        <button type="submit" id="sendBtn" class="btn">Send Securely</button>
      </div>
    </form>
  </div>

  <div id="toast" class="toast">✓ Transmission sent</div>

  <!-- OpenPGP (client-side crypto) -->
  <script src="https://cdn.jsdelivr.net/npm/openpgp@5.11.0/dist/openpgp.min.js"></script>
<script>
  // === CONFIG ===
  const WORKER_URL = 'https://sb-relay.overwatch1790.workers.dev/'; // your Cloudflare Worker
  const PUBLIC_KEY_ASC = `
-----BEGIN PGP PUBLIC KEY BLOCK-----

xjMEZKBTyBYJKwYBBAHaRw8BAQdAVnqbCVaw5PyjOnOkJolNcZIG8U/LaQRC
t2PQBBH3P/fNMU92ZXJXYXRjaDE3OTBAcHJvdG9uLm1lIDxPdmVyV2F0Y2gx
NzkwQHByb3Rvbi5tZT7CjAQQFgoAPgWCZKBTyAQLCQcICZBm/yLWGD5NWwMV
CAoEFgACAQIZAQKbAwIeARYhBDoIkVCKSMHFEf3rHmb/ItYYPk1bAABpggEA
9CWvaM0t2Jf5OZr+eTm5QEgBCRj+SdP43rSA8ZoI4bgBANPcCr+8TFU86dtt
lF8Lag4Ivxw6SG8+lADyIkw1XsMPzjgEZKBTyBIKKwYBBAGXVQEFAQEHQI9N
25+McxGwawd57BEcA/H8vdtHEQtOJA4WWc6kd9NUAwEIB8J4BBgWCAAqBYJk
oFPICZBm/yLWGD5NWwKbDBYhBDoIkVCKSMHFEf3rHmb/ItYYPk1bAAA3wQEA
ulQ5Hh0rfIwhUk6jg/ngwFls70af1syyHZN8MNVRJRsA/jzWdlbt0uMVDqgj
pcXFYA7QTSj2EvumxD3cuKHVQ80N
=i34q
-----END PGP PUBLIC KEY BLOCK-----
`.trim();
</script>
    // === Matrix background ===
    (function(){
      const canvas = document.getElementById('matrix');
      const ctx = canvas.getContext('2d');
      function size(){ canvas.width=innerWidth; canvas.height=innerHeight; }
      addEventListener('resize', size); size();
      const letters = "01";
      const fs = 16;
      let cols = Math.floor(canvas.width / fs);
      let drops = Array(cols).fill(1);
      function draw(){
        ctx.fillStyle = "rgba(0,0,0,0.07)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "#0f0";
        ctx.font = fs + "px monospace";
        for(let i=0;i<drops.length;i++){
          const text = letters[Math.floor(Math.random()*letters.length)];
          ctx.fillText(text, i*fs, drops[i]*fs);
          if(drops[i]*fs > canvas.height && Math.random() > 0.975) drops[i]=0;
          drops[i]++;
        }
      }
      setInterval(draw, 33);
    })();

    // === UI wiring ===
    const openBtn = document.getElementById('openSecure');
    const panel   = document.getElementById('panel');
    const form    = document.getElementById('sb-form');
    const status  = document.getElementById('sb-status');
    const sendBtn = document.getElementById('sendBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const toast   = document.getElementById('toast');

    document.getElementById('sb-ts').value = Date.now();

    openBtn.addEventListener('click', ()=>{
      panel.classList.add('show');
      panel.setAttribute('aria-hidden','false');
      setTimeout(()=>document.getElementById('sb-message').focus(), 220);
    });

    cancelBtn.addEventListener('click', ()=>{
      panel.classList.remove('show','dissolve');
      panel.setAttribute('aria-hidden','true');
      status.textContent = '';
      form.reset();
      document.getElementById('sb-ts').value = Date.now();
    });

    // === Encryption helper ===
    async function encryptForSB(plaintext){
      const pubKey = await openpgp.readKey({ armoredKey: PUBLIC_KEY_ASC });
      const message = await openpgp.createMessage({ text: plaintext });
      return await openpgp.encrypt({
        message, encryptionKeys: pubKey,
        config: { preferredCompressionAlgorithm: openpgp.enums.compression.zlib }
      });
    }

    // === Submit handler → encrypt locally → send to Worker ===
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      sendBtn.disabled = true;

      const callsign = document.getElementById('sb-callsign').value.trim();
      const reply    = document.getElementById('sb-email').value.trim();
      const msg      = document.getElementById('sb-message').value.trim();

      if(!msg){ status.textContent = 'Message is required.'; sendBtn.disabled=false; return; }

      status.textContent = 'Encrypting…';
      let cipher;
      try{
        const plain =
`Callsign: ${callsign || '(none)'}
Reply (optional): ${reply || '(none)'}
---
${msg}`;
        cipher = await encryptForSB(plain);
      }catch(err){
        status.textContent = 'Encryption failed.';
        sendBtn.disabled=false; return;
      }

      status.textContent = 'Transmitting…';
      try{
        const r = await fetch(WORKER_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ callsign, reply, cipher })
        });

        if(r.ok){
          status.textContent = '✓ Transmission sent';
          toast.classList.add('show');
          // dissolve back to portal
          setTimeout(()=>{
            toast.classList.remove('show');
            panel.classList.add('dissolve');
            setTimeout(()=>{
              form.reset();
              panel.classList.remove('show','dissolve');
              panel.setAttribute('aria-hidden','true');
              status.textContent = '';
              sendBtn.disabled = false;
              document.getElementById('sb-ts').value = Date.now();
            }, 800);
          }, 1800);
        } else {
          status.textContent = 'Send failed. Try again.';
          sendBtn.disabled=false;
        }
      }catch(err){
        status.textContent = 'Network error. Try again.';
        sendBtn.disabled=false;
      }
    });
  </script>
</body>
</html>
