<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Silent Beacon – Secure Communications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --g:#0f0; }
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--g);font-family:"Courier New",monospace;overflow:hidden}
    /* Matrix bg */
    #matrix{position:fixed;inset:0;z-index:-1}

    .container{display:flex;flex-direction:column;align-items:center;margin-top:15vh;text-align:center;text-shadow:0 0 10px var(--g),0 0 20px var(--g);padding:0 16px}
    h1{margin:0 0 20px;font-size:2.2rem}

    .btn{
      border:2px solid var(--g); background:transparent; color:var(--g);
      padding:14px 30px; letter-spacing:2px; text-transform:uppercase; cursor:pointer;
      box-shadow:0 0 10px var(--g), inset 0 0 5px var(--g); transition:.25s transform,.25s box-shadow,.25s background;
    }
    .btn:hover{transform:scale(1.05);background:rgba(0,255,0,.18);box-shadow:0 0 20px var(--g), inset 0 0 10px var(--g)}

    /* Slide-in secure panel */
    .panel{
      width:min(780px,92vw); margin-top:18px; border:2px solid var(--g);
      background:rgba(0,0,0,.55); box-shadow:0 0 20px rgba(0,255,0,.25), inset 0 0 10px rgba(0,255,0,.15);
      text-align:left; overflow:hidden; max-height:0; opacity:0; transition:max-height .45s ease, opacity .45s ease;
    }
    .panel.show{max-height:1000px; opacity:1}

    .panel-inner{padding:18px}
    .row{margin-bottom:12px}
    label{display:block;margin-bottom:6px;letter-spacing:1px}
    input,textarea{
      width:100%; box-sizing:border-box; background:rgba(0,0,0,.82); border:1px solid var(--g); color:var(--g);
      padding:10px 12px; font-family:inherit; outline:none; box-shadow:inset 0 0 6px rgba(0,255,0,.15)
    }
    textarea{min-height:140px; resize:vertical}
    .small{font-size:.9em;opacity:.85;letter-spacing:1px}
    .muted{opacity:.7}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .inline-btn{border:1px solid var(--g);background:transparent;color:var(--g);padding:8px 12px;letter-spacing:1px;text-transform:uppercase;cursor:pointer}
    .inline-btn:hover{background:rgba(0,255,0,.15)}

    /* Transmission toast */
    .toast{
      position:fixed; left:50%; top:18%; transform:translate(-50%,-50%);
      pointer-events:none; opacity:0; transition:opacity .25s ease;
      font-weight:bold; font-size:1.2rem; letter-spacing:2px;
      text-shadow:0 0 6px var(--g),0 0 14px var(--g);
    }
    .toast.show{opacity:1; animation:blink 1.6s steps(4) 1}
    @keyframes blink { 50%{opacity:.35} }

    /* dissolve */
    .dissolve{animation:dissolve .65s ease forwards}
    @keyframes dissolve { to { opacity:0; filter:blur(6px); transform:scale(.985) } }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <div class="container">
    <h1>Silent Beacon – Secure Communications</h1>
    <button id="openSecure" class="btn">Secure</button>

    <div id="securePanel" class="panel" aria-hidden="true">
      <div class="panel-inner">
        <form id="secureForm" action="https://formspree.io/f/mpwlnnel" method="POST" autocomplete="off">
          <div class="row">
            <label for="sb-callsign">Callsign <span class="small muted">(required)</span></label>
            <input id="sb-callsign" name="name" required />
          </div>

          <div class="row">
            <label for="sb-email">Reply email <span class="small muted">(optional)</span></label>
            <input id="sb-email" type="email" name="_replyto" placeholder="For full E2E, use ProtonMail (optional)" />
          </div>

          <div class="row">
            <label for="sb-message">Message <span class="small muted">(required)</span></label>
            <textarea id="sb-message" name="message" required></textarea>
          </div>

          <!-- anti-bot -->
          <input type="text" name="_gotcha" style="display:none">
          <input type="hidden" name="ts" id="sb-ts">

          <div class="actions">
            <button type="submit" class="inline-btn">Send Secure</button>
            <span id="sb-status" class="small muted"></span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">TRANSMISSION SENT</div>

  <!-- Proton PUBLIC key (your real key embedded) -->
  <script id="sb-pubkey" type="application/pgp-keys">
-----BEGIN PGP PUBLIC KEY BLOCK-----

xjMEZKBTyBYJKwYBBAHaRw8BAQdAVnqbCVaw5PyjOnOkJolNcZIG8U/LaQRC
t2PQBBH3P/fNMU92ZXJXYXRjaDE3OTBAcHJvdG9uLm1lIDxPdmVyV2F0Y2gx
NzkwQHByb3Rvbi5tZT7CjAQQFgoAPgWCZKBTyAQLCQcICZBm/yLWGD5NWwMV
CAoEFgACAQIZAQKbAwIeARYhBDoIkVCKSMHFEf3rHmb/ItYYPk1bAABpggEA
9CWvaM0t2Jf5OZr+eTm5QEgBCRj+SdP43rSA8ZoI4bgBANPcCr+8TFU86dtt
lF8Lag4Ivxw6SG8+lADyIkw1XsMPzjgEZKBTyBIKKwYBBAGXVQEFAQEHQI9N
25+McxGwawd57BEcA/H8vdtHEQtOJA4WWc6kd9NUAwEIB8J4BBgWCAAqBYJk
oFPICZBm/yLWGD5NWwKbDBYhBDoIkVCKSMHFEf3rHmb/ItYYPk1bAAA3wQEA
ulQ5Hh0rfIwhUk6jg/ngwFls70af1syyHZN8MNVRJRsA/jzWdlbt0uMVDqgj
pcXFYA7QTSj2EvumxD3cuKHVQ80N
=i34q
-----END PGP PUBLIC KEY BLOCK-----
  </script>

  <!-- OpenPGP.js -->
  <script src="https://unpkg.com/openpgp@5/dist/openpgp.min.js"></script>

  <script>
    // Matrix background (resizable)
    const cvs = document.getElementById('matrix'), ctx = cvs.getContext('2d');
    let letters='01', fontSize=14, cols=0, drops=[];
    function size(){ cvs.width = innerWidth; cvs.height = innerHeight; cols = Math.ceil(cvs.width/fontSize); drops = Array.from({length:cols}, ()=>1); }
    size(); addEventListener('resize', size);
    setInterval(()=>{ ctx.fillStyle='rgba(0,0,0,.05)'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.fillStyle='#0f0'; ctx.font=fontSize+'px monospace';
      for(let i=0;i<drops.length;i++){ const t=letters[Math.random()*letters.length|0]; ctx.fillText(t,i*fontSize,drops[i]*fontSize);
        if(drops[i]*fontSize>cvs.height && Math.random()>0.975) drops[i]=0; drops[i]++; }},33);

    // UI show/hide
    const openBtn = document.getElementById('openSecure');
    const panel = document.getElementById('securePanel');
    openBtn.addEventListener('click', ()=>{ panel.classList.add('show'); panel.setAttribute('aria-hidden','false'); });

    // Pre-fill anti-bot ts
    document.getElementById('sb-ts').value = Date.now();

    async function encryptForSB(plain){
      const armored = document.getElementById('sb-pubkey').textContent.trim();
      const pubKey  = await openpgp.readKey({armoredKey: armored});
      const message = await openpgp.createMessage({ text: plain });
      return await openpgp.encrypt({ message, encryptionKeys: pubKey });
    }

    // Submit handler
    const form   = document.getElementById('secureForm');
    const status = document.getElementById('sb-status');
    const toast  = document.getElementById('toast');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      status.textContent = 'Encrypting…';

      // Gather fields
      const callsign = document.getElementById('sb-callsign').value.trim();
      const reply    = document.getElementById('sb-email').value.trim();
      const message  = document.getElementById('sb-message').value.trim();

      // Build plaintext to encrypt (include reply email inside ciphertext too)
      const plain =
`Callsign: ${callsign || '(none)'}
Reply (optional): ${reply || '(none)'}
---
${message}`;

      let cipher;
      try {
        cipher = await encryptForSB(plain);
      } catch(err){
        status.textContent = 'Encryption failed.';
        return;
      }

      status.textContent = 'Transmitting…';

      // Build FormData: replace message with ciphertext
      const fd = new FormData(form);
      fd.set('message', cipher);

      try{
        const res = await fetch(form.action, { method:'POST', headers:{'Accept':'application/json'}, body: fd });
        if(res.ok){
          // success → matrix toast + dissolve + reset
          toast.classList.add('show');
          panel.classList.add('dissolve');
          setTimeout(()=>{ toast.classList.remove('show'); }, 1600);
          setTimeout(()=>{
            form.reset();
            panel.classList.remove('show','dissolve');
            panel.setAttribute('aria-hidden','true');
            status.textContent = '';
            document.getElementById('sb-ts').value = Date.now();
          }, 2100);
        }else{
          status.textContent = 'Send failed. Try again.';
        }
      }catch(err){
        status.textContent = 'Network error. Try again.';
      }
    });
  </script>
</body>
</html>
